<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-73036WSLVP"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-73036WSLVP');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>EarthVault - Environmental</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@500;800&family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #0f172a; 
            color: #f1f5f9; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .font-mono-data { font-family: 'JetBrains Mono', monospace; }
        .glass-nav { 
            background: rgba(15, 23, 42, 0.95); 
            backdrop-filter: blur(12px); 
            border-bottom: 1px solid rgba(255,255,255,0.1);
            -webkit-backdrop-filter: blur(12px);
        }
        .vault-card { 
            background: rgba(30, 41, 59, 0.5); 
            backdrop-filter: blur(8px); 
            border: 1px solid rgba(255,255,255,0.05); 
            transition: all 0.3s ease;
            -webkit-backdrop-filter: blur(8px);
        }
        .search-glow:focus { 
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.3); 
            outline: none;
        }
        
        /* Mobile-specific improvements */
        @media (max-width: 768px) {
            .mode-buttons {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 0.5rem;
                width: 100%;
            }
            
            .mode-btn {
                padding: 0.75rem 1rem;
                font-size: 10px;
                white-space: nowrap;
            }
            
            .search-container {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .search-btn {
                width: 100%;
                padding: 1rem;
            }
            
            .fact-box {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .fact-content {
                flex-direction: column;
                align-items: center;
                gap: 0.75rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .stat-divider {
                display: none;
            }
            
            .stat-container {
                border-right: none !important;
                border-bottom: 1px solid rgba(255,255,255,0.05);
                padding-bottom: 2rem;
            }
            
            .stat-container:last-child {
                border-bottom: none;
                padding-bottom: 0;
            }
            
            .year-grid {
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 0.5rem;
            }
            
            .year-item {
                padding: 0.5rem !important;
            }
            
            .chart-container {
                height: 300px !important;
                padding: 1rem !important;
            }
            
            .extreme-cards {
                grid-template-columns: 1fr !important;
            }
            
            .page-padding {
                padding: 1rem !important;
            }
            
            .main-title {
                font-size: 2rem !important;
                line-height: 1.2;
            }
            
            .impact-grid {
                grid-template-columns: 1fr !important;
                gap: 0.75rem;
            }
            
            .modal-content {
                max-width: 90vw;
                padding: 2rem !important;
            }
            
            .attribution {
                bottom: 0.5rem !important;
                right: 0.5rem !important;
                font-size: 8px !important;
                padding: 0.5rem 0.75rem !important;
            }
            
            .badge-container {
                flex-direction: column;
                align-items: center;
            }
        }
        
        /* Touch-friendly sizing */
        button, a, [onclick] {
            min-height: 44px;
            min-width: 44px;
            cursor: pointer;
        }
        
        /* Improved scrolling on mobile */
        * {
            -webkit-overflow-scrolling: touch;
        }
        
        /* Better card spacing on small screens */
        @media (max-width: 640px) {
            .vault-card {
                border-radius: 1.5rem;
            }
            
            .rounded-3xl {
                border-radius: 1.5rem;
            }
            
            .text-6xl {
                font-size: 3rem;
            }
            
            .text-5xl {
                font-size: 2.5rem;
            }
        }
    </style>
</head>
<body class="min-h-screen relative overflow-x-hidden pb-20">

    <div class="fixed top-0 left-0 w-full h-full pointer-events-none -z-10">
        <div class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-indigo-500/10 blur-[120px] rounded-full"></div>
    </div>

    <div id="source-attribution" class="attribution fixed bottom-4 right-4 z-50 pointer-events-none">
        <a id="attribution-link" href="https://open-meteo.com/" target="_blank" 
           class="pointer-events-auto bg-slate-900/60 backdrop-blur-md border border-white/10 px-4 py-2 rounded-full text-[10px] font-bold text-slate-400 hover:text-white transition-all uppercase tracking-widest shadow-xl">
            Data by Open-Meteo
        </a>
    </div>

    <nav class="glass-nav p-3 md:p-4 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-3 md:gap-4">
            <h1 class="font-black tracking-tighter text-xl md:text-2xl uppercase italic text-white">Earth<span class="text-emerald-400">Vault</span></h1>
            <div class="mode-buttons flex bg-slate-900/80 rounded-2xl p-1.5 gap-1 border border-white/5 w-full md:w-auto">
                <button id="mode-weather" onclick="setMode('weather')" class="mode-btn px-5 py-2 rounded-xl text-[11px] font-extrabold transition-all bg-indigo-600 text-white shadow-lg uppercase tracking-wider">Weather</button>
                <button id="mode-forest" onclick="setMode('forest')" class="mode-btn px-5 py-2 rounded-xl text-[11px] font-extrabold transition-all hover:bg-slate-800 text-green-400 uppercase tracking-wider">Forests</button>
                <button id="mode-agri" onclick="setMode('agri')" class="mode-btn px-5 py-2 rounded-xl text-[11px] font-extrabold transition-all hover:bg-slate-800 text-amber-400 uppercase tracking-wider">Agri</button>
                <button id="mode-energy" onclick="setMode('energy')" class="mode-btn px-5 py-2 rounded-xl text-[11px] font-extrabold transition-all hover:bg-slate-800 text-orange-400 uppercase tracking-wider">Energy</button>
                <button id="mode-water" onclick="setMode('water')" class="mode-btn px-5 py-2 rounded-xl text-[11px] font-extrabold transition-all hover:bg-slate-800 text-cyan-400 uppercase tracking-wider">Water</button>
            </div>
        </div>
    </nav>

    <div class="page-padding max-w-7xl mx-auto p-4 md:p-6 lg:p-12">
        <header class="text-center mb-8 md:mb-12">
            <h1 id="main-title" class="main-title text-3xl md:text-5xl font-extrabold text-white tracking-tight mb-3 italic px-4">Weather History Vault</h1>
            <p id="main-subtitle" class="text-slate-400 text-base md:text-lg font-light px-4">Global Environmental Terminal</p>
            
            <div id="fact-box" class="fact-box mt-6 md:mt-8 mx-auto max-w-2xl bg-slate-900/40 border border-white/5 rounded-2xl md:rounded-3xl p-4 md:p-5 backdrop-blur-sm flex items-center justify-between">
                <div class="fact-content flex items-center gap-4 md:gap-5 text-left">
                    <div id="fact-icon" class="text-2xl md:text-3xl">üå™Ô∏è</div>
                    <div>
                        <h4 class="text-[10px] font-bold text-indigo-400 uppercase tracking-[0.2em] mb-1">Archive Intel</h4>
                        <p id="fact-text" class="text-xs md:text-sm text-slate-300 italic">Initiating atmospheric scan...</p>
                    </div>
                </div>
                <button onclick="shuffleFact()" class="p-2 rounded-full hover:bg-white/5 text-slate-500 hover:text-indigo-400 transition-all flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                </button>
            </div>

            <div class="badge-container mt-4 md:mt-6 flex flex-wrap justify-center gap-3 md:gap-4 px-4">
                <div class="inline-flex items-center gap-2 bg-indigo-500/10 border border-indigo-500/20 px-3 md:px-4 py-2 rounded-full text-indigo-400 text-[10px] font-bold uppercase tracking-widest">
                    <span class="flex h-2 w-2 rounded-full bg-indigo-500 animate-ping"></span> Archive Active
                </div>
                <div id="era-trend" onclick="showInfo('era')" class="hidden cursor-help inline-flex items-center gap-2 bg-slate-900/60 border border-white/5 px-3 md:px-4 py-2 rounded-full text-[10px] font-bold text-slate-300"></div>
                <button onclick="clearCityCache()" class="text-[10px] font-bold text-slate-500 uppercase hover:text-red-400 transition-colors tracking-widest px-3 py-2">Wipe Cache üóëÔ∏è</button>
            </div>
        </header>

        <div class="search-container flex flex-col md:flex-row gap-3 mb-8 md:mb-12 justify-center max-w-3xl mx-auto px-4">
            <input type="text" id="cityInput" placeholder="Search region..." class="flex-1 bg-slate-900/90 border border-white/10 px-4 md:px-6 py-3 md:py-4 rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none text-white text-base md:text-lg search-glow transition-all">
            <button onclick="mainAction()" id="searchBtn" class="search-btn bg-indigo-600 hover:bg-indigo-500 text-white px-8 md:px-10 py-3 md:py-4 rounded-2xl font-bold transition-all uppercase tracking-tighter shadow-xl shadow-indigo-600/20">Analyze</button>
        </div>

        <div id="app-content" class="opacity-0 transition-all duration-700">
            <div id="impact-row" class="impact-grid grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-5 mb-6 md:mb-8 hidden"></div>

            <div class="stats-grid grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8 mb-6 md:mb-8">
                <div class="vault-card rounded-[2rem] md:rounded-[2.5rem] p-1 flex flex-col relative overflow-hidden">
                    <div id="top-card-label" class="absolute top-3 md:top-4 left-4 md:left-6 text-[9px] font-black text-slate-500 uppercase tracking-[0.3em]">Temporal Delta</div>
                    <div class="flex flex-1 pt-10 md:pt-12 pb-6 md:pb-8">
                        <div class="stat-container flex-1 px-4 md:px-8 text-center border-r border-white/5">
                            <h3 id="stat1-label" class="text-[11px] font-black text-indigo-400 uppercase tracking-widest mb-2">Today High</h3>
                            <p id="today-temp" class="text-4xl md:text-6xl font-black text-white my-2 md:my-3 font-mono-data tracking-tighter">--</p>
                            <span id="comparison-tag" class="px-3 md:px-4 py-1 md:py-1.5 rounded-xl text-[10px] font-extrabold inline-block">--</span>
                        </div>
                        <div id="stat2-container" class="stat-container flex-1 px-4 md:px-8 text-center">
                            <h3 id="stat2-label" class="text-[11px] font-black text-slate-500 uppercase tracking-widest mb-2">Humidity</h3>
                            <p id="today-humid" class="text-4xl md:text-6xl font-black text-cyan-400 my-2 md:my-3 font-mono-data tracking-tighter">--</p>
                            <div id="streak-val" onclick="showInfo('streak')" class="cursor-help text-[10px] font-bold text-orange-400 uppercase mt-2 tracking-wide underline underline-offset-4 decoration-dotted">Streak: -- days</div>
                        </div>
                    </div>
                    <div id="weather-footer" class="bg-white/5 p-4 md:p-5 flex justify-around text-[10px] font-bold uppercase rounded-b-[1.9rem] md:rounded-b-[2.4rem]">
                        <div class="text-slate-400">Day Avg: <span id="avg-temp" class="text-indigo-400">--</span></div>
                        <div class="text-slate-400">Pollution: <span id="pollution-val" class="text-red-400">--</span></div>
                    </div>
                </div>

                <div class="bg-slate-900 rounded-[2rem] md:rounded-[2.5rem] p-6 md:p-8 border border-white/5 flex flex-col relative overflow-hidden">
                     <div id="dark-card-title" class="text-[9px] font-black text-slate-500 uppercase tracking-[0.3em] mb-6 md:mb-8">Historical Vault Peaks</div>
                     <div class="flex justify-between items-center h-full text-center relative z-10">
                         <div class="flex-1">
                             <h4 id="ext1-label" class="text-red-500/80 text-[11px] font-black uppercase mb-3 tracking-widest">Record Max</h4>
                             <p id="rec-hot-val" class="text-3xl md:text-5xl font-black text-white font-mono-data">--</p>
                             <div class="mt-3 md:mt-4 inline-block px-3 py-1 bg-white/5 rounded-lg text-xs text-slate-500 font-bold">Year <span id="rec-hot-year" class="text-slate-300">--</span></div>
                         </div>
                         <div class="stat-divider w-px h-24 bg-gradient-to-b from-transparent via-slate-700 to-transparent mx-2 md:mx-4"></div>
                         <div class="flex-1">
                             <h4 id="ext2-label" class="text-blue-400/80 text-[11px] font-black uppercase mb-3 tracking-widest">Record Min</h4>
                             <p id="rec-cold-val" class="text-3xl md:text-5xl font-black text-white font-mono-data">--</p>
                             <div class="mt-3 md:mt-4 inline-block px-3 py-1 bg-white/5 rounded-lg text-xs text-slate-500 font-bold">Year <span id="rec-cold-year" class="text-slate-300">--</span></div>
                         </div>
                     </div>
                </div>
            </div>

            <div id="weather-extreme-cards" class="extreme-cards grid grid-cols-1 md:grid-cols-2 gap-5 md:gap-6 mb-8 md:mb-12">
                <div class="bg-gradient-to-br from-orange-600 to-orange-800 p-6 md:p-8 rounded-[2rem] md:rounded-[2.5rem] text-white text-center relative overflow-hidden">
                    <h3 class="text-orange-200 text-[11px] font-black uppercase tracking-[0.2em] mb-2">Extreme Heat</h3>
                    <p id="extreme-days" class="text-4xl md:text-5xl font-black font-mono-data">--</p>
                    <p class="text-[10px] text-orange-200/60 mt-3 md:mt-4 uppercase font-bold">Days hit 30¬∞C+ (This Date over 50y)</p>
                </div>
                <div class="bg-gradient-to-br from-indigo-700 to-indigo-900 p-6 md:p-8 rounded-[2rem] md:rounded-[2.5rem] text-white text-center relative overflow-hidden">
                    <h3 class="text-indigo-200 text-[11px] font-black uppercase tracking-[0.2em] mb-2">Historical Frost</h3>
                    <p id="freezing-days" class="text-4xl md:text-5xl font-black font-mono-data">--</p>
                    <p class="text-[10px] text-indigo-200/60 mt-3 md:mt-4 uppercase font-bold">Days hit sub-zero (This Date over 50y)</p>
                </div>
            </div>

            <div class="chart-container bg-slate-900/50 p-4 md:p-8 rounded-[2rem] md:rounded-[3rem] border border-white/5 mb-8 md:mb-12 h-[300px] md:h-[450px]">
                <canvas id="historyChart"></canvas>
            </div>

            <div class="bg-slate-900/30 p-6 md:p-10 rounded-[2rem] md:rounded-[3rem] border border-white/5">
                <h3 id="timeline-title" class="text-xs font-black text-slate-500 uppercase mb-6 md:mb-8 tracking-[0.4em] text-center italic">Timeline</h3>
                <div id="year-list" class="year-grid grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-10 gap-2 md:gap-3"></div>
            </div>
        </div>
    </div>

    <div id="infoModal" class="hidden fixed inset-0 bg-slate-950/90 backdrop-blur-xl z-[100] flex items-center justify-center p-4 md:p-6" onclick="closeModal()">
        <div class="modal-content bg-slate-900 border border-white/10 rounded-[2rem] md:rounded-[2.5rem] max-w-sm w-full p-8 md:p-10 text-center" onclick="event.stopPropagation()">
            <h2 id="modalTitle" class="text-xl md:text-2xl font-black text-white mb-4 uppercase"></h2>
            <p id="modalBody" class="text-slate-400 text-sm leading-relaxed mb-6 md:mb-8"></p>
            <button onclick="closeModal()" class="w-full bg-white text-slate-900 font-bold py-3 md:py-4 rounded-2xl">Close</button>
        </div>
    </div>

    <script>
        let chartInstance = null;
        let currentMode = 'weather';
        const today = new Date();
        const currentYear = today.getFullYear();
        const monthDayToday = `${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        
        const facts = {
            weather: ["Lightning strikes the Earth 100 times every second.", "Air near lightning is 5x hotter than the sun's surface.", "The coldest temperature recorded was -89.2¬∞C.", "Hurricane energy equals 10,000 nuclear bombs.", "Raindrops look like hamburger buns, not teardrops."],
            forest: ["Forests house 80% of terrestrial biodiversity.", "Oak trees support over 500 different species.", "The Amazon produces about 20% of Earth's oxygen.", "Trees use a 'Wood Wide Web' to communicate.", "25% of modern medicine comes from rainforest plants."],
            agri: ["Agriculture consumes 70% of the world's accessible freshwater.", "Cereal yields have tripled globally since the 1960s.", "Healthy soil contains more living organisms than there are people on Earth.", "Sustainable farming can reduce carbon levels in the atmosphere."],
            energy: ["Sunlight hitting Earth for 1 hour could power the world for a year.", "Solar is now the cheapest energy source in history.", "Iceland uses 100% renewable geothermal and hydro.", "One wind turbine turn can power a home for a day.", "Renewable energy creates 3x more jobs than fossil fuels."],
            water: ["Only 0.5% of Earth's water is available fresh water.", "A child dies every 90 seconds from a water-related disease.", "Global water demand is projected to increase by 55% by 2050.", "Agriculture accounts for 70% of global freshwater withdrawals.", "Safely managed water must be free from pathogens and chemicals."]
        };

        function shuffleFact() {
            const list = facts[currentMode];
            document.getElementById('fact-text').innerText = list[Math.floor(Math.random() * list.length)];
            const icons = { weather: 'üå™Ô∏è', forest: 'üå≥', agri: 'üåæ', energy: '‚ö°', water: 'üíß' };
            document.getElementById('fact-icon').innerText = icons[currentMode];
        }

        function setMode(mode) {
            document.getElementById('app-content').classList.add('opacity-0');
            document.getElementById('cityInput').value = "";
            currentMode = mode;
            
            const attrBtn = document.getElementById('attribution-link');
            if (mode === 'weather') {
                attrBtn.innerText = "Data by Open-Meteo";
                attrBtn.href = "https://open-meteo.com/";
            } else {
                attrBtn.innerText = "Data by World Bank";
                attrBtn.href = "https://data.worldbank.org/";
            }

            document.getElementById('stat1-label').innerText = "Today High";
            document.getElementById('stat2-label').innerText = "Humidity";
            document.getElementById('top-card-label').innerText = "Today vs 50y Average";
            document.getElementById('dark-card-title').innerText = "Historical Vault Peaks";
            document.getElementById('ext1-label').innerText = "Record Max";
            document.getElementById('ext2-label').innerText = "Record Min";
            document.getElementById('timeline-title').innerText = "Timeline";

            ['weather', 'forest', 'agri', 'energy', 'water'].forEach(m => {
                const btn = document.getElementById(`mode-${m}`);
                if(!btn) return;
                let baseClass = 'mode-btn px-5 py-2 rounded-xl text-[11px] font-extrabold transition-all uppercase tracking-wider ';
                if (mode === m) {
                    if (m === 'energy') btn.className = baseClass + 'bg-orange-600 text-white shadow-lg shadow-orange-500/20';
                    else if (m === 'forest') btn.className = baseClass + 'bg-green-600 text-white shadow-lg shadow-cyan-500/20';
                    else if (m === 'water') btn.className = baseClass + 'bg-cyan-600 text-white shadow-lg shadow-cyan-500/20';
                    else if (m === 'agri') btn.className = baseClass + 'bg-amber-600 text-white shadow-lg shadow-amber-500/20';
                    else btn.className = baseClass + 'bg-indigo-600 text-white shadow-lg shadow-indigo-500/20';
                } else {
                    btn.className = baseClass + 'hover:bg-slate-800 text-slate-400';
                }
            });

            const titles = {
                weather: "Weather History Vault",
                forest: "Forest Heritage Vault",
                agri: "Agriculture Vault",
                energy: "Energy & Renewables Vault",
                water: "Water Quality & Safety Vault"
            };
            document.getElementById('main-title').innerText = titles[mode];
            document.getElementById('cityInput').placeholder = mode === 'weather' ? "Search city..." : "Search country...";
            
            if (mode !== 'weather') document.getElementById('era-trend').classList.add('hidden');
            shuffleFact();
        }

        function clearCityCache() { localStorage.clear(); alert("Storage cleared."); }

        async function mainAction() {
            const query = document.getElementById('cityInput').value.trim();
            if(!query) return;
            const btn = document.getElementById('searchBtn');
            btn.disabled = true; btn.innerText = 'Analyzing...';
            if(currentMode === 'weather') await searchWeather(query);
            else await searchWBData(query);
            btn.disabled = false; btn.innerText = 'Analyze';
        }

        async function searchWeather(query) {
            try {
                const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}&count=1&language=en&format=json`);
                const geoData = await geoRes.json();
                if (geoData.results?.length > 0) {
                    const { latitude, longitude } = geoData.results[0];
                    const start = (currentYear - 50) + "-01-01";
                    const end = today.toISOString().split('T')[0];
                    const wRes = await fetch(`https://archive-api.open-meteo.com/v1/archive?latitude=${latitude}&longitude=${longitude}&start_date=${start}&end_date=${end}&daily=temperature_2m_max,temperature_2m_mean,relative_humidity_2m_mean&timezone=auto`);
                    const weatherData = await wRes.json();
                    const pRes = await fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${latitude}&longitude=${longitude}&current=pm2_5`);
                    const pollutionData = await pRes.json();
                    processWeatherData(weatherData, pollutionData);
                } else { alert("City not found"); }
            } catch (e) { alert("API Busy."); }
        }

        function processWeatherData(data, pollutionData) {
            document.getElementById('impact-row').classList.add('hidden');
            document.getElementById('weather-extreme-cards').classList.remove('hidden');
            document.getElementById('weather-footer').classList.remove('hidden');
            document.getElementById('stat2-container').classList.remove('invisible');
            document.getElementById('timeline-title').innerText = "50-Year Annual Averages (Mean)";

            const dailyHistory = []; 
            const yearlyData = {};
            const allMaxTemps = data.daily.temperature_2m_max;

            data.daily.time.forEach((t, i) => {
                const year = t.substring(0, 4);
                const mean = data.daily.temperature_2m_mean[i];
                if (!yearlyData[year]) yearlyData[year] = { sum: 0, count: 0 };
                if (mean !== null) { yearlyData[year].sum += mean; yearlyData[year].count += 1; }
                if (t.endsWith(monthDayToday)) {
                    dailyHistory.push({ year, temp: allMaxTemps[i], humid: data.daily.relative_humidity_2m_mean[i] });
                }
            });

            if (dailyHistory.length === 0) return;
            const latest = dailyHistory[dailyHistory.length-1];

            let maxStreak = 0, currentStreak = 0;
            allMaxTemps.forEach(temp => {
                if (Math.abs(temp - latest.temp) <= 2) currentStreak++;
                else { if (currentStreak > maxStreak) maxStreak = currentStreak; currentStreak = 0; }
            });
            document.getElementById('streak-val').innerText = `Streak: ${maxStreak} days`;

            const annualList = Object.keys(yearlyData).map(y => yearlyData[y].sum / (yearlyData[y].count || 1));
            const eraDiff = ((annualList.slice(-25).reduce((a,b)=>a+b,0)/25) - (annualList.slice(0,25).reduce((a,b)=>a+b,0)/25)).toFixed(2);
            document.getElementById('era-trend').classList.remove('hidden');
            document.getElementById('era-trend').innerHTML = `Era Shift: <span class="${eraDiff > 0 ? 'text-rose-500' : 'text-blue-400'}">${eraDiff > 0 ? '+' : ''}${eraDiff}¬∞C</span>`;

            document.getElementById('extreme-days').innerText = dailyHistory.filter(d=>d.temp>=30).length;
            document.getElementById('freezing-days').innerText = dailyHistory.filter(d=>d.temp<0).length;
            document.getElementById('today-temp').innerText = `${latest.temp.toFixed(1)}¬∞`;
            document.getElementById('today-humid').innerText = `${Math.round(latest.humid)}%`;
            document.getElementById('avg-temp').innerText = `${(dailyHistory.reduce((a,b)=>a+b.temp,0) / dailyHistory.length).toFixed(1)}¬∞C`;
            
            const tDiff = (latest.temp - (dailyHistory.reduce((a,b)=>a+b.temp,0) / dailyHistory.length)).toFixed(1);
            document.getElementById('comparison-tag').innerText = tDiff > 0 ? `${tDiff}¬∞C ABOVE AVG` : `${Math.abs(tDiff)}¬∞C BELOW AVG`;
            document.getElementById('comparison-tag').className = `px-4 py-1.5 rounded-xl text-[10px] font-black mt-1 ${tDiff > 0 ? 'bg-rose-500/20 text-rose-400' : 'bg-blue-500/20 text-blue-400'}`;

            if (pollutionData?.current) document.getElementById('pollution-val').innerText = pollutionData.current.pm2_5.toFixed(1);
            const sorted = [...dailyHistory].sort((a,b) => b.temp - a.temp);
            document.getElementById('rec-hot-val').innerText = `${sorted[0].temp.toFixed(1)}¬∞`;
            document.getElementById('rec-hot-year').innerText = sorted[0].year;
            document.getElementById('rec-cold-val').innerText = `${sorted[dailyHistory.length-1].temp.toFixed(1)}¬∞`;
            document.getElementById('rec-cold-year').innerText = sorted[dailyHistory.length-1].year;

            renderYearGrid(yearlyData, '¬∞', 'weather');
            renderChart(dailyHistory, 'Temp ¬∞C', '#6366f1');
            document.getElementById('app-content').classList.remove('opacity-0');
        }

        async function searchWBData(query) {
            try {
                const cl = await fetch(`https://api.worldbank.org/v2/country?format=json&per_page=300`).then(r => r.json());
                const country = cl[1].find(c => c.name.toLowerCase().includes(query.toLowerCase()));
                if(!country) throw new Error("Country not found");
                
                let indicators = {
                    forest: 'AG.LND.FRST.ZS',
                    energy: 'EG.ELC.RNEW.ZS',
                    water: 'SH.H2O.SMDW.ZS',
                    agri: 'AG.LND.AGRI.ZS'
                };

                let ind1 = indicators[currentMode];
                const ind2 = currentMode === 'energy' ? 'EG.ELC.HYRO.ZS' : null;
                const [r1, r2] = await Promise.all([
                    fetch(`https://api.worldbank.org/v2/country/${country.id}/indicator/${ind1}?format=json&per_page=100`).then(r => r.json()),
                    ind2 ? fetch(`https://api.worldbank.org/v2/country/${country.id}/indicator/${ind2}?format=json&per_page=100`).then(r => r.json()) : Promise.resolve([null, []])
                ]);
                processWBResults(r1[1], r2[1], country.name);
            } catch (e) { alert(e.message); }
        }

        function processWBResults(percData, hydroData, name) {
            const history = (percData || []).filter(d => d.value !== null).map(d => ({ year: d.date, val: parseFloat(d.value.toFixed(2)) })).reverse();
            if (!history || history.length === 0) {
                alert("Data unavailable.");
                return;
            }
            const latest = history[history.length-1];
            const growth = latest.val - history[0].val;

            document.getElementById('impact-row').classList.remove('hidden');
            document.getElementById('weather-extreme-cards').classList.add('hidden');
            document.getElementById('weather-footer').classList.add('hidden');
            document.getElementById('timeline-title').innerText = "Historical Timeline";

            if(currentMode === 'energy') {
                const lh = hydroData && hydroData.length > 0 ? parseFloat(hydroData.find(d => d.value !== null)?.value || 0) : 0;
                document.getElementById('impact-row').innerHTML = `<div class="bg-blue-500/10 border border-blue-500/20 p-6 rounded-[2rem] text-center"><h5 class="text-[10px] font-black text-blue-400 mb-2 text-center">Hydro Power</h5><p class="text-3xl font-black">${lh.toFixed(1)}%</p></div><div class="bg-orange-500/10 border border-orange-500/20 p-6 rounded-[2rem] text-center"><h5 class="text-[10px] font-black text-orange-400 mb-2 text-center">Solar & Wind</h5><p class="text-3xl font-black">${(latest.val - lh).toFixed(1)}%</p></div><div class="bg-slate-800/50 p-6 rounded-[2rem] text-center"><h5 class="text-[10px] font-black text-slate-500 mb-2 text-center">Fossil Gap</h5><p class="text-3xl font-black text-white">${(100 - latest.val).toFixed(1)}%</p></div>`;
            } else if(currentMode === 'water') {
                document.getElementById('impact-row').innerHTML = `<div class="bg-cyan-500/10 border border-cyan-500/20 p-6 rounded-[2rem] text-center lg:col-span-1 text-center"><h5 class="text-[10px] font-black text-cyan-400 mb-2 text-center">Water Safety</h5><p class="text-3xl font-black">${latest.val}%</p></div><div class="bg-rose-500/10 border border-rose-500/20 p-6 rounded-[2rem] text-center lg:col-span-2 text-center"><h5 class="text-[10px] font-black text-rose-400 mb-2 text-center">Pollution Risk</h5><p class="text-3xl font-black">${(100 - latest.val).toFixed(1)}%</p></div>`;
            } else if(currentMode === 'agri') {
                document.getElementById('impact-row').innerHTML = `<div class="bg-amber-500/10 border border-amber-500/20 p-6 rounded-[2rem] text-center lg:col-span-2 text-center"><h5 class="text-[10px] font-black text-amber-400 mb-2">Total Land Usage</h5><p class="text-3xl font-black">${latest.val}%</p></div><div class="bg-indigo-500/10 border border-indigo-500/20 p-6 rounded-[2rem] text-center lg:col-span-1 text-center"><h5 class="text-[10px] font-black text-indigo-400 mb-2">Data Years</h5><p class="text-3xl font-black">${history.length}</p></div>`;
            } else {
                document.getElementById('impact-row').innerHTML = `<div class="bg-emerald-500/10 border border-emerald-500/20 p-6 rounded-[2rem] text-center lg:col-span-2 text-center"><h5 class="text-[10px] font-black text-emerald-400 mb-2">Total Coverage</h5><p class="text-3xl font-black">${latest.val}%</p></div><div class="bg-indigo-500/10 border border-indigo-500/20 p-6 rounded-[2rem] text-center lg:col-span-1 text-center"><h5 class="text-[10px] font-black text-indigo-400 mb-2">Data Years</h5><p class="text-3xl font-black">${history.length}</p></div>`;
            }

            const lbls = { forest: `Forest Cover (${latest.year})`, energy: `Renewables (${latest.year})`, water: `Safe Water (${latest.year})`, agri: `Agri Land (${latest.year})` };
            document.getElementById('stat1-label').innerText = lbls[currentMode];
            document.getElementById('today-temp').innerText = latest.val + "%";
            document.getElementById('comparison-tag').innerText = `${name.toUpperCase()} REGION`;
            document.getElementById('stat2-label').innerText = currentMode === 'water' ? "Safety Gap" : "Net Change";
            document.getElementById('today-humid').innerText = currentMode === 'water' ? (100 - latest.val).toFixed(1) + "%" : (growth >= 0 ? '+' : '') + growth.toFixed(1) + "%";
            document.getElementById('today-humid').className = `text-4xl md:text-6xl font-black my-2 md:my-3 font-mono-data tracking-tighter ${currentMode === 'water' ? 'text-rose-400' : (growth >= 0 ? 'text-emerald-400' : 'text-rose-400')}`;
            
            document.getElementById('rec-hot-val').innerText = Math.max(...history.map(h=>h.val)) + "%";
            document.getElementById('rec-hot-year').innerText = history.find(h=>h.val === Math.max(...history.map(h=>h.val))).year;
            document.getElementById('rec-cold-val').innerText = Math.min(...history.map(h=>h.val)) + "%";
            document.getElementById('rec-cold-year').innerText = history.find(h=>h.val === Math.min(...history.map(h=>h.val))).year;

            renderYearGrid(history, '%', currentMode);
            const clrs = { forest: '#10b981', energy: '#f97316', water: '#0891b2', agri: '#d97706' };
            renderChart(history, 'Value %', clrs[currentMode]);
            document.getElementById('app-content').classList.remove('opacity-0');
        }

        function renderYearGrid(data, unit, mode) {
            const list = document.getElementById('year-list'); list.innerHTML = '';
            const annuals = Array.isArray(data) ? data : Object.keys(data).map(y => ({ year: y, val: data[y].sum / (data[y].count || 1) }));
            const peak = [...annuals].sort((a,b) => b.val - a.val)[0];
            const lowest = [...annuals].sort((a,b) => a.val - b.val)[0];
            [...annuals].reverse().forEach(item => {
                let bg = "bg-slate-900/40", tc = "text-slate-300", bd = "", bc = "border-white/5";
                if(item.year === peak.year) {
                    if (mode === 'weather') { bc = "border-rose-500/50"; bg = "bg-rose-500/10"; tc = "text-rose-400"; bd = `<div class="text-[7px] font-black text-rose-500 uppercase mb-1">Peak</div>`; }
                    else { bg = mode === 'forest' ? 'bg-green-600' : (mode === 'energy' ? 'bg-orange-600' : (mode === 'agri' ? 'bg-amber-600' : 'bg-cyan-700')); tc = "text-white"; bd = `<div class="text-[7px] font-black uppercase mb-1">Peak</div>`; }
                } else if(item.year === lowest.year) {
                    if (mode === 'weather') { bc = "border-blue-500/50"; bg = "bg-blue-500/10"; tc = "text-blue-400"; bd = `<div class="text-[7px] font-black text-blue-500 uppercase mb-1">Floor</div>`; }
                    else { bg = "bg-blue-600"; tc = "text-white"; bd = `<div class="text-[7px] font-black uppercase mb-1">Floor</div>`; }
                }
                list.innerHTML += `<div class="year-item ${bg} p-3 rounded-2xl border ${bc} text-center transition-all hover:scale-110 cursor-default">${bd}<div class="text-[9px] font-bold opacity-50 mb-1">${item.year}</div><div class="text-xs font-black ${tc}">${(item.val || 0).toFixed(1)}${unit}</div></div>`;
            });
        }

        function renderChart(history, label, color) {
            const ctx = document.getElementById('historyChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, { 
                type: 'line', 
                data: { 
                    labels: history.map(h => h.year), 
                    datasets: [{ 
                        label, 
                        data: history.map(h => h.val || h.temp), 
                        borderColor: color, 
                        borderWidth: 3, 
                        pointRadius: window.innerWidth < 768 ? 0 : 2,
                        pointHoverRadius: window.innerWidth < 768 ? 4 : 6,
                        tension: 0.4, 
                        fill: true, 
                        backgroundColor: color + '11' 
                    }] 
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { display: false },
                        tooltip: { mode: 'index', intersect: false }
                    }, 
                    scales: { 
                        y: { 
                            grid: { color: 'rgba(255,255,255,0.05)' }, 
                            ticks: { color: '#64748b', font: { size: window.innerWidth < 768 ? 10 : 12 } } 
                        }, 
                        x: { 
                            grid: { display: false }, 
                            ticks: { color: '#64748b', maxRotation: window.innerWidth < 768 ? 45 : 0, minRotation: window.innerWidth < 768 ? 45 : 0, font: { size: window.innerWidth < 768 ? 9 : 12 } } 
                        } 
                    },
                    interaction: { mode: 'nearest', axis: 'x', intersect: false }
                } 
            });
        }

        function closeModal() { document.getElementById('infoModal').classList.add('hidden'); }
        function showInfo(type) {
            const modal = document.getElementById('infoModal');
            document.getElementById('modalTitle').innerText = type === 'era' ? "Era Shift" : "System Streak";
            document.getElementById('modalBody').innerText = type === 'era' ? "Compares the first 25 years vs the last 25 years." : "Consecutive days mirroring today's intensity.";
            modal.classList.remove('hidden');
        }

        document.getElementById('cityInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') { mainAction(); }
        });

        shuffleFact();
    </script>
</body>
</html>
